---
# Tasks for tesing role

- name: test docker_sandbox role
  hosts: localhost
  roles:
    - role: docker_presets
    - role: docker_sandbox
      docker_sandbox_state: started
      docker_sandbox_idempotence_test_recreate_after: true
  tasks:
    - name: assert that idempotence test was ok
      assert:
        that: not docker_sandbox_idempotence_result | failed

- name: test containers recreation after running idempotence test
  hosts: docker_sandbox_containers
  tasks:
    - name: check /tmp/testfile file
      stat:
        path: /tmp/testfile
      register: check_testfile_result

    - name: check testfile file does not exist
      assert:
        that: not check_testfile_result.stat.exists

- name: test disabling docker containers recreation idempotence test
  hosts: localhost
  roles:
    - role: docker_sandbox
      docker_sandbox_state: recreated
      docker_sandbox_idempotence_test_recreate_after: false

- name: test containers has not been recreated after idempotence test
  hosts: docker_sandbox_containers
  tasks:
    - name: check /tmp/testfile file
      stat:
        path: /tmp/testfile
      register: check_testfile_result

    - name: check /tmp/testfile file exists
      assert:
        that: check_testfile_result.stat.exists

- name: test with explicit inventory file
  hosts: localhost
  roles:
    - role: docker_sandbox
      docker_sandbox_state: recreated
      docker_sandbox_inventory: "./docker_sandbox_inventory"

- name: test cleanup by ppid
  hosts: localhost
  roles:
    - role: docker_sandbox
      docker_sandbox_cleanup_by_ppid: true
      docker_sandbox_cleanup_by_user: false
      docker_sandbox_cleanup_by_playbook: false
  tasks:
    - name: search explicit inventory from previous test
      stat:
        path: "./docker_sandbox_inventory"
      register: check_explicit_inventory_result

    - name: check explicit inventory from previous test does not exist
      assert:
        that:
          - not check_explicit_inventory_result.stat.exists

    - name: search running docker containers created by the test
      shell: >-
        docker ps -a --format='{''{.Names}''}'
        --filter label=docker_sandbox_ppid={{ lookup(
          'pipe',
          'ps -o ppid= -p `ps -o ppid= -p $PPID`')
          | trim }}
      changed_when: false
      register: search_test_containers_result

    - name: verify only running docker containers are the last ones created
      assert:
       that: item in docker_sandbox_containers | map(attribute='name') | list
      with_items: "{{ search_test_containers_result.stdout_lines }}"

- name: test cleanup by user
  hosts: localhost
  roles:
    - role: docker_sandbox
      docker_sandbox_cleanup_by_ppid: false
      docker_sandbox_cleanup_by_user: true
      docker_sandbox_cleanup_by_playbook: false
  tasks:
    - name: search running docker containers created by the test
      shell: >-
        docker ps -a --format='{''{.Names}''}'
        --filter label=docker_sandbox_ppid={{ lookup(
          'pipe',
          'ps -o ppid= -p `ps -o ppid= -p $PPID`')
          | trim }}
      changed_when: false
      register: search_test_containers_result

    - name: verify only running docker containers are the last ones created
      assert:
       that: item in docker_sandbox_containers | map(attribute='name') | list
      with_items: "{{ search_test_containers_result.stdout_lines }}"

- name: test cleanup by playbook
  hosts: localhost
  roles:
    - role: docker_sandbox
      docker_sandbox_cleanup_by_ppid: false
      docker_sandbox_cleanup_by_user: false
      docker_sandbox_cleanup_by_playbook: true
  tasks:
    - name: search running docker containers created by the test
      shell: >-
        docker ps -a --format='{''{.Names}''}'
        --filter label=docker_sandbox_ppid={{ lookup(
          'pipe',
          'ps -o ppid= -p `ps -o ppid= -p $PPID`')
          | trim }}
      changed_when: false
      register: search_test_containers_result

    - name: verify only running docker containers are the last ones created
      assert:
       that: item in docker_sandbox_containers | map(attribute='name') | list
      with_items: "{{ search_test_containers_result.stdout_lines }}"

- name: create file for testing
  hosts: docker_sandbox_containers
  tasks:
    - name: create testing file
      copy:
        content: "Hello World"
        dest: /tmp/testfile
        force: no
  tags:
    - idempotence

- name: cleanup docker docker sandbox
  hosts: localhost
  roles:
    - role: docker_sandbox
      docker_sandbox_state: absent
